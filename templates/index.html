<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ç›¾å±æœºç®¡ç†ç³»ç»Ÿ - ä¸­æ§å¤§å±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #0c1445 0%, #1a237e 50%, #283593 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 30px;
            text-align: center;
            border-bottom: 2px solid #3f51b5;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(63, 81, 181, 0.8);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 80px - 120px); /* ä¸ºèŠå¤©å®¹å™¨ç•™å‡ºæ›´å¤šç©ºé—´ */
        }

        .graph-container {
            flex: 1.5; /* å‡å°‘å›¾å½¢åŒºåŸŸæ¯”ä¾‹ï¼Œç»™å³ä¾§é¢æ¿æ›´å¤šç©ºé—´ */
            position: relative;
            padding: 20px 20px 60px 20px; /* å¢åŠ åº•éƒ¨paddingï¼Œé¿å…é®æŒ¡ */
            overflow: hidden;
        }

        .graph-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .connection-line {
            stroke: #3f51b5;
            stroke-width: 2;
            fill: none;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .connection-line.active {
            stroke: #2196f3;
            stroke-width: 3;
            opacity: 1;
            animation: flow 2s infinite;
        }

        @keyframes flow {
            0% { stroke-dasharray: 0, 10; }
            100% { stroke-dasharray: 10, 0; }
        }

        .agent-node {
            position: absolute;
            width: 130px; /* ç¨å¾®å‡å°å®½åº¦ */
            height: 90px; /* ç¨å¾®å‡å°é«˜åº¦ */
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #3f51b5;
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            transition: all 0.3s ease;
            z-index: 2;
            backdrop-filter: blur(10px);
            margin-bottom: 10px; /* ç¡®ä¿åº•éƒ¨æœ‰é—´è· */
        }

        .agent-node.active {
            border-color: #2196f3;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.5);
            transform: scale(1.05);
        }

        .agent-node.completed {
            border-color: #4caf50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }

        .agent-node.waiting {
            border-color: #ff9800;
            box-shadow: 0 0 20px rgba(255, 152, 0, 0.5);
        }

        .agent-node::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            border-radius: 12px;
            opacity: 0;
            transition: opacity 0.6s;
            z-index: -1;
        }

        .agent-node.active::before {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .agent-name {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 4px;
            color: #e3f2fd;
            line-height: 1.1;
        }

        .agent-status {
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 4px;
        }

        .agent-message {
            font-size: 8px;
            color: #b3e5fc;
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* é‡æ–°è°ƒæ•´æ™ºèƒ½ä½“ä½ç½® - é¿å…è¿æ¥çº¿è¢«é®æŒ¡ï¼Œæ•´ä½“ä¸Šç§»å¹¶ä¼˜åŒ–é—´è· */
        #sentiment_sentinel { top: 20px; left: 280px; }
        #technical_diagnostician { top: 140px; left: 120px; }
        #pr_strategist { top: 140px; left: 280px; }
        #legal_counsel { top: 140px; left: 440px; }
        #decision_gateway { top: 260px; left: 280px; }
        #action_coordinator { top: 380px; left: 280px; }
        #status_check { top: 500px; left: 150px; }
        #post_mortem_analyst { top: 500px; left: 410px; }

        .info-panel {
            flex: 1.5; /* å¢åŠ å³ä¾§é¢æ¿æ¯”ä¾‹ */
            background: rgba(0, 0, 0, 0.2);
            border-left: 2px solid #3f51b5;
            padding: 15px;
            overflow-y: auto;
            max-height: calc(100vh - 80px - 120px);
        }

        .info-section {
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #3f51b5;
        }

        .info-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #64b5f6;
        }

        .info-content {
            font-size: 12px;
            line-height: 1.4;
            color: #e1f5fe;
            white-space: pre-wrap;
            max-height: 300px; /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé¿å…è¿‡é•¿å†…å®¹ */
            overflow-y: auto;
        }

        /* ä¸ºä¸åŒç±»å‹çš„ä¿¡æ¯æ·»åŠ ç‰¹æ®Šæ ·å¼ */
        .info-section.alert { border-left-color: #f44336; }
        .info-section.technical { border-left-color: #2196f3; }
        .info-section.pr { border-left-color: #4caf50; }
        .info-section.legal { border-left-color: #ff9800; }
        .info-section.proposal { border-left-color: #9c27b0; }
        .info-section.task-distribution { border-left-color: #ff9800; }
        .info-section.department-execution { border-left-color: #4caf50; }
        .info-section.sentiment { border-left-color: #e91e63; }
        .info-section.post-mortem { border-left-color: #607d8b; }
        .info-section.approval { border-left-color: #ff5722; }

        /* æ‰¹å‡†è¯·æ±‚æ ·å¼ */
        .approval-request {
            background: rgba(255, 87, 34, 0.1);
            border: 1px solid #ff5722;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            animation: pulse-approval 2s infinite;
        }

        @keyframes pulse-approval {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 87, 34, 0.3); }
            50% { box-shadow: 0 0 15px rgba(255, 87, 34, 0.6); }
        }

        .approval-agent {
            font-weight: bold;
            color: #ff7043;
            margin-bottom: 5px;
        }

        .approval-action {
            color: #ffccbc;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .approval-explanation {
            color: #fff3e0;
            margin-bottom: 10px;
            font-style: italic;
            font-size: 12px;
        }

        .approval-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .approval-btn {
            padding: 6px 15px;
            border: none;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .approval-btn.approve {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            color: white;
        }

        .approval-btn.reject {
            background: linear-gradient(45deg, #f44336, #ef5350);
            color: white;
        }

        .approval-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .approval-status {
            text-align: center;
            padding: 5px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .approval-status.approved {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .approval-status.rejected {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .chat-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px; /* ä»100pxå¢åŠ åˆ°120px */
            background: rgba(0, 0, 0, 0.9);
            border-top: 2px solid #3f51b5;
            padding: 20px 15px; /* å¢åŠ å‚ç›´padding */
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            max-width: 1200px;
            margin: 0 auto;
            align-items: center;
            height: 100%;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #3f51b5;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 14px;
            outline: none;
            height: 50px;
        }

        .chat-input::placeholder {
            color: #b3e5fc;
        }

        .chat-input:focus {
            border-color: #2196f3;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }

        .send-btn, .start-btn, .stop-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 50px;
            min-width: 120px;
            white-space: nowrap;
        }

        .send-btn, .start-btn {
            background: linear-gradient(45deg, #3f51b5, #2196f3);
        }

        .stop-btn {
            background: linear-gradient(45deg, #f44336, #ef5350);
        }

        .send-btn:hover, .start-btn:hover {
            background: linear-gradient(45deg, #2196f3, #3f51b5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .stop-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #ef5350, #f44336);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .send-btn:disabled, .start-btn:disabled, .stop-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a237e, #283593);
            margin: 15% auto;
            padding: 30px;
            border: 2px solid #3f51b5;
            border-radius: 15px;
            width: 80%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #64b5f6;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.yes {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            color: white;
        }

        .modal-btn.no {
            background: linear-gradient(45deg, #f44336, #ef5350);
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .info-panel::-webkit-scrollbar {
            width: 8px;
        }

        .info-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .info-panel::-webkit-scrollbar-thumb {
            background: rgba(63, 81, 181, 0.6);
            border-radius: 4px;
        }

        .info-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(63, 81, 181, 0.8);
        }

        /* ä»»åŠ¡åˆ†å‘å’Œéƒ¨é—¨æ‰§è¡ŒçŠ¶æ€çš„ç‰¹æ®Šæ ·å¼ */
        .task-distribution {
            border-left-color: #ff9800;
        }

        .department-execution {
            border-left-color: #4caf50;
        }

        .execution-item {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .execution-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        .status-executing {
            background: rgba(33, 150, 243, 0.3);
            color: #2196f3;
        }

        .status-completed {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .status-pending {
            background: rgba(255, 152, 0, 0.3);
            color: #ff9800;
        }

        /* é€šçŸ¥åŠ¨ç”» */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .agent-node {
                width: 120px;
                height: 90px;
                font-size: 11px;
            }
            
            .agent-name {
                font-size: 11px;
            }
            
            .agent-status {
                font-size: 9px;
            }
            
            .agent-message {
                font-size: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›¡ï¸ ç¥ç›¾å±æœºç®¡ç†ç³»ç»Ÿ - ä¸­æ§å¤§å±</h1>
    </div>

    <div class="main-container">
        <div class="graph-container">
            <!-- SVGè¿æ¥çº¿ -->
            <svg class="graph-svg">
                <!-- æ›´æ–°è¿æ¥çº¿è·¯å¾„ä»¥åŒ¹é…æ–°çš„æ™ºèƒ½ä½“ä½ç½® -->
                <path class="connection-line" id="line-1" d="M 345,65 Q 345,100 190,140"></path> <!-- Sentiment to Tech -->
                <path class="connection-line" id="line-2" d="M 185,185 H 280"></path> <!-- Tech to PR -->
                <path class="connection-line" id="line-3" d="M 345,185 H 440"></path> <!-- PR to Legal -->
                <path class="connection-line" id="line-4" d="M 190,185 Q 235,220 345,260"></path> <!-- Tech to Gateway -->
                <path class="connection-line" id="line-5" d="M 505,185 Q 425,220 345,260"></path> <!-- Legal to Gateway -->
                <path class="connection-line" id="line-6" d="M 345,305 V 380"></path> <!-- Gateway to Coordinator -->
                <path class="connection-line" id="line-7" d="M 345,425 Q 250,460 215,500"></path> <!-- Coordinator to Status Check -->
                <path class="connection-line" id="line-8" d="M 215,545 H 410"></path> <!-- Status Check to Post Mortem -->
                <path class="connection-line" id="line-9" d="M 215,500 Q 50,400 50,65 Q 50,20 280,20"></path> <!-- Loop back to Sentiment -->
            </svg>

            <!-- æ™ºèƒ½ä½“èŠ‚ç‚¹ -->
            <div class="agent-node" id="sentiment_sentinel">
                <div class="agent-name">ğŸ“ˆ èˆ†æƒ…å“¨å…µ</div>
                <div class="agent-status">å¾…æœº</div>
                <div class="agent-message"></div>
            </div>
            
            <div class="agent-node" id="technical_diagnostician">
                <div class="agent-name">ğŸ”§ é¦–å¸­æŠ€æœ¯è¯Šæ–­å®˜</div>
                <div class="agent-status">å¾…æœº</div>
                <div class="agent-message"></div>
            </div>
            
            <div class="agent-node" id="pr_strategist">
                <div class="agent-name">ğŸ“¢ å…¬å…³ç­–ç•¥å¸ˆ</div>
                <div class="agent-status">å¾…æœº</div>
                <div class="agent-message"></div>
            </div>
            
            <div class="agent-node" id="legal_counsel">
                <div class="agent-name">âš–ï¸ æ³•åŠ¡ä¸åˆè§„é¡¾é—®</div>
                <div class="agent-status">å¾…æœº</div>
                <div class="agent-message"></div>
            </div>
            
            <div class="agent-node" id="decision_gateway">
                <div class="agent-name">ğŸ‘‘ å†³ç­–ä¸­å¿ƒ (äººç±»/AIåˆ†èº«)</div>
                <div class="agent-status">å¾…æœº</div>
                <div class="agent-message"></div>
            </div>
            
            <div class="agent-node" id="action_coordinator">
                <div class="agent-name">ğŸ¯ è·¨éƒ¨é—¨è¡ŒåŠ¨åè°ƒå®˜</div>
                <div class="agent-status">å¾…æœº</div>
                <div class="agent-message"></div>
            </div>
            
            <div class="agent-node" id="status_check">
                <div class="agent-name">âœ… å±æœºçŠ¶æ€æ£€æŸ¥</div>
                <div class="agent-status">å¾…æœº</div>
                <div class="agent-message"></div>
            </div>
            
            <div class="agent-node" id="post_mortem_analyst">
                <div class="agent-name">ğŸ“ å¤ç›˜åˆ†æå¸ˆ</div>
                <div class="agent-status">å¾…æœº</div>
                <div class="agent-message"></div>
            </div>
        </div>

        <div class="info-panel">
            <div class="info-section alert" id="alert-section" style="display: none;">
                <div class="info-title">ğŸš¨ å±æœºè­¦æŠ¥</div>
                <div class="info-content" id="alert-content"></div>
            </div>
            
            <div class="info-section technical" id="technical-report-section" style="display: none;">
                <div class="info-title">ğŸ”§ æŠ€æœ¯è¯Šæ–­æŠ¥å‘Š</div>
                <div class="info-content" id="technical-report-content"></div>
            </div>
            
            <div class="info-section pr" id="pr-strategy-section" style="display: none;">
                <div class="info-title">ğŸ“¢ å…¬å…³ç­–ç•¥æ–¹æ¡ˆ</div>
                <div class="info-content" id="pr-strategy-content"></div>
            </div>
            
            <div class="info-section legal" id="legal-review-section" style="display: none;">
                <div class="info-title">âš–ï¸ æ³•å¾‹é£é™©è¯„ä¼°</div>
                <div class="info-content" id="legal-review-content"></div>
            </div>
            
            <div class="info-section proposal" id="comprehensive-proposal-section" style="display: none;">
                <div class="info-title">ğŸ“‹ ç»¼åˆå¤„ç†æ–¹æ¡ˆ</div>
                <div class="info-content" id="comprehensive-proposal-content"></div>
            </div>

            <div class="info-section approval" id="approval-requests-section" style="display: none;">
                <div class="info-title">ğŸ”” æ™ºèƒ½ä½“è¡ŒåŠ¨æ‰¹å‡†è¯·æ±‚</div>
                <div class="info-content" id="approval-requests-content"></div>
            </div>

            <div class="info-section task-distribution" id="task-distribution-section" style="display: none;">
                <div class="info-title">ğŸ“‹ ä»»åŠ¡åˆ†å‘çŠ¶æ€</div>
                <div class="info-content" id="task-distribution-content"></div>
            </div>

            <div class="info-section department-execution" id="department-execution-section" style="display: none;">
                <div class="info-title">ğŸ¯ å„éƒ¨é—¨æ‰§è¡ŒçŠ¶æ€</div>
                <div class="info-content" id="department-execution-content"></div>
            </div>
            
            <div class="info-section sentiment" id="realtime-sentiment-section" style="display: none;">
                <div class="info-title">ğŸ“Š å®æ—¶èˆ†æƒ…åé¦ˆ</div>
                <div class="info-content" id="realtime-sentiment-content"></div>
            </div>

            <div class="info-section" id="human-decision-section" style="display: none;">
                <div class="info-title">ğŸ‘‘ æŒ‡æŒ¥å®˜å†³ç­–</div>
                <div class="info-content" id="human-decision-content"></div>
            </div>

            <div class="info-section" id="parsed-tasks-section" style="display: none;">
                <div class="info-title">ğŸ¯ è§£æåä»»åŠ¡</div>
                <div class="info-content" id="parsed-tasks-content"></div>
            </div>

            <div class="info-section" id="executed-actions-section" style="display: none;">
                <div class="info-title">âš¡ æ‰§è¡Œç»“æœ</div>
                <div class="info-content" id="executed-actions-content"></div>
            </div>

            <div class="info-section" id="incident-log-section" style="display: none;">
                <div class="info-title">ğŸ“‹ äº‹ä»¶æ—¥å¿—</div>
                <div class="info-content" id="incident-log-content"></div>
            </div>
            
            <div class="info-section post-mortem" id="post-mortem-report-section" style="display: none;">
                <div class="info-title">ğŸ“ å¤ç›˜åˆ†ææŠ¥å‘Š</div>
                <div class="info-content" id="post-mortem-report-content"></div>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-input-container">
            <button class="start-btn" onclick="startSystem()">ğŸš€ å¯åŠ¨ç¥ç›¾ç³»ç»Ÿ</button>
            <button class="stop-btn" onclick="stopSystem()" disabled>ğŸ›‘ åœæ­¢ç³»ç»Ÿ</button>
            <input type="text" class="chat-input" id="commandInput" placeholder="ç³»ç»Ÿæœªå¯åŠ¨" disabled>
            <button class="send-btn" onclick="sendCommand()" disabled id="sendBtn">å‘é€æŒ‡ä»¤</button>
        </div>
    </div>

    <!-- å±æœºçŠ¶æ€ç¡®è®¤å¼¹çª— -->
    <div id="crisisModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ” å±æœºçŠ¶æ€ç¡®è®¤</h3>
            <p>å½“å‰å±æœºæ˜¯å¦å·²ç»è§£å†³ï¼Ÿ</p>
            <div class="modal-buttons">
                <button class="modal-btn yes" onclick="confirmCrisisStatus(true)">âœ… å·²è§£å†³</button>
                <button class="modal-btn no" onclick="confirmCrisisStatus(false)">âŒ æœªè§£å†³</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let commandInputEnabled = false;

        // è¿æ¥çº¿æ˜ å°„ - å®šä¹‰å“ªäº›è¿æ¥çº¿å¯¹åº”å“ªäº›æ™ºèƒ½ä½“
        const connectionMap = {
            'sentiment_sentinel': ['line-1'], // To tech diagnostician
            'technical_diagnostician': ['line-2'], // To PR
            'pr_strategist': ['line-3'], // To Legal
            'legal_counsel': ['line-4'], // To Gateway
            'decision_gateway': ['line-5'], // To Coordinator
            'action_coordinator': ['line-6', 'line-7'], // To crisis check and BACK to sentiment
            'status_check': ['line-8', 'line-9'], // To post-mortem or loop back to tech
            'post_mortem_analyst': []
        };

        // è¿æ¥äº‹ä»¶
        socket.on('connect', function() {
            console.log('ğŸ”— å·²è¿æ¥åˆ°ç¥ç›¾ç³»ç»Ÿ');
        });

        socket.on('connected', function(data) {
            console.log('âœ… è¿æ¥ç¡®è®¤:', data.data);
        });

        // ç³»ç»Ÿå¯åŠ¨äº‹ä»¶
        socket.on('system_started', function(data) {
            console.log('ğŸš€ ç³»ç»Ÿå¯åŠ¨:', data.message);
            document.querySelector('.start-btn').disabled = true;
            document.querySelector('.start-btn').textContent = 'ç³»ç»Ÿè¿è¡Œä¸­...';
            document.querySelector('.stop-btn').disabled = false;
            // å¯ç”¨éšæ—¶æŒ‡ä»¤è¾“å…¥
            enableCommandInput();
        });

        // æ™ºèƒ½ä½“çŠ¶æ€æ›´æ–°
        socket.on('agent_status_update', function(data) {
            console.log('ğŸ”„ æ™ºèƒ½ä½“çŠ¶æ€æ›´æ–°:', data);
            updateAgentStatus(data.agent, data.status, data.color, data.message);
        });

        // ç³»ç»Ÿä¿¡æ¯æ›´æ–°
        socket.on('system_info_update', function(data) {
            console.log('ğŸ“Š ç³»ç»Ÿä¿¡æ¯æ›´æ–°:', data.type);
            updateSystemInfo(data.type, data.content);
        });

        // å±æœºçŠ¶æ€æ£€æŸ¥
        socket.on('crisis_status_check', function(data) {
            console.log('ğŸ” å±æœºçŠ¶æ€æ£€æŸ¥:', data.message);
            document.getElementById('crisisModal').style.display = 'block';
        });

        // æŒ‡ä»¤æ¥æ”¶ç¡®è®¤
        socket.on('command_received', function(data) {
            console.log('ğŸ“¨ æŒ‡ä»¤å·²æ¥æ”¶:', data.message);
            document.getElementById('commandInput').value = '';
            // ç«‹å³å¤„ç†æ¨¡å¼ä¸‹ï¼Œä¿æŒè¾“å…¥æ¡†å¯ç”¨çŠ¶æ€
            if (data.message.includes('ç«‹å³å¤„ç†')) {
                // çŸ­æš‚ç¦ç”¨åé‡æ–°å¯ç”¨ï¼Œç»™ç”¨æˆ·åé¦ˆ
                document.getElementById('commandInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                setTimeout(() => {
                    enableCommandInput();
                }, 1000);
            } else {
                // æµç¨‹ä¸­å¤„ç†ï¼Œç¦ç”¨è¾“å…¥æ¡†
                document.getElementById('commandInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            }
        });

        // æŒ‡ä»¤å¤„ç†å®Œæˆ
        socket.on('command_processed', function(data) {
            console.log('âœ… æŒ‡ä»¤å¤„ç†å®Œæˆ:', data);
            // æ˜¾ç¤ºå¤„ç†ç»“æœé€šçŸ¥
            showNotification(`æŒ‡ä»¤å¤„ç†å®Œæˆ: ${data.command} (${data.tasks_count}é¡¹ä»»åŠ¡) - ${data.timestamp}`);
        });

        // æ‰¹å‡†è¯·æ±‚æ›´æ–°
        socket.on('approval_requests_update', function(data) {
            console.log('ğŸ”” æ‰¹å‡†è¯·æ±‚æ›´æ–°:', data.requests);
            updateApprovalRequests(data.requests);
        });

        // æ‰¹å‡†è¯·æ±‚é€šçŸ¥
        socket.on('approval_request', function(data) {
            console.log('ğŸ”” æ–°çš„æ‰¹å‡†è¯·æ±‚:', data);
            showNotification(`${data.agent} è¯·æ±‚è¡ŒåŠ¨æ‰¹å‡†: ${data.explanation}`);
        });

        // æ‰¹å‡†å†³ç­–ç¡®è®¤
        socket.on('approval_decision_received', function(data) {
            console.log('ğŸ“‹ æ‰¹å‡†å†³ç­–å·²æ¥æ”¶:', data);
            showNotification(data.message);
        });

        // ç³»ç»Ÿå®Œæˆ
        socket.on('system_completed', function(data) {
            console.log('âœ… ç³»ç»Ÿæ‰§è¡Œå®Œæˆ:', data.message);
            resetSystem();
        });

        // ç³»ç»Ÿåœæ­¢
        socket.on('system_stopped', function(data) {
            console.log('ğŸ›‘ ç³»ç»Ÿå·²åœæ­¢:', data.message);
            resetSystem();
        });

        // ç³»ç»Ÿé”™è¯¯
        socket.on('system_error', function(data) {
            console.error('âŒ ç³»ç»Ÿé”™è¯¯:', data.error);
            alert('ç³»ç»Ÿæ‰§è¡Œå‡ºé”™: ' + data.error);
            resetSystem();
        });

        function startSystem() {
            console.log('ğŸš€ å¯åŠ¨ç¥ç›¾ç³»ç»Ÿ...');
            socket.emit('start_system');
        }

        function stopSystem() {
            console.log('ğŸ›‘ åœæ­¢ç¥ç›¾ç³»ç»Ÿ...');
            socket.emit('stop_system');
        }

        function showNotification(message) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(76, 175, 80, 0.9);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 9999;
                font-size: 14px;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function updateAgentStatus(agentName, status, color, message) {
            const agentNode = document.getElementById(agentName);
            if (agentNode) {
                const statusElement = agentNode.querySelector('.agent-status');
                const messageElement = agentNode.querySelector('.agent-message');
                
                statusElement.textContent = status;
                messageElement.textContent = message;
                
                // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                agentNode.classList.remove('active', 'completed', 'waiting');
                
                // æ·»åŠ å¯¹åº”çš„çŠ¶æ€ç±»
                if (color === 'blue') {
                    agentNode.classList.add('active');
                    // æ¿€æ´»ç›¸å…³è¿æ¥çº¿
                    activateConnectionLines(agentName, true);
                } else if (color === 'green') {
                    // ç»¿è‰²çŠ¶æ€ï¼šé—ªåŠ¨2ç§’åæ¢å¤å¾…æœº
                    agentNode.classList.add('completed');
                    // å–æ¶ˆæ¿€æ´»è¿æ¥çº¿
                    activateConnectionLines(agentName, false);
                    
                    // 2ç§’åè‡ªåŠ¨æ¢å¤åˆ°å¾…æœºçŠ¶æ€
                    setTimeout(() => {
                        agentNode.classList.remove('completed');
                        statusElement.textContent = 'å¾…æœº';
                        messageElement.textContent = '';
                        console.log(`ğŸ”„ ${agentName} è‡ªåŠ¨æ¢å¤åˆ°å¾…æœºçŠ¶æ€`);
                    }, 2000);
                    
                } else if (color === 'orange') {
                    agentNode.classList.add('waiting');
                    
                    // å¦‚æœæ˜¯äººç±»å†³ç­–ç½‘å…³ç­‰å¾…æŒ‡ä»¤ï¼Œå¯ç”¨è¾“å…¥æ¡†
                    if (agentName === 'decision_gateway' && status === 'ç­‰å¾…æŒ‡ä»¤') {
                        enableCommandInput();
                    }
                    
                    // æ©™è‰²çŠ¶æ€ä¸è‡ªåŠ¨æ¢å¤ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’æˆ–ç³»ç»Ÿæ¨è¿›
                    
                } else {
                    // ç°è‰²çŠ¶æ€ï¼Œå–æ¶ˆæ¿€æ´»è¿æ¥çº¿
                    activateConnectionLines(agentName, false);
                }
            }
        }

        function activateConnectionLines(agentName, activate) {
            const lines = connectionMap[agentName];
            if (lines) {
                lines.forEach(lineId => {
                    const line = document.getElementById(lineId);
                    if (line) {
                        if (activate) {
                            line.classList.add('active');
                        } else {
                            line.classList.remove('active');
                        }
                    }
                });
            }
        }

        function updateSystemInfo(type, content) {
            const sectionMap = {
                'alert': 'alert-section',
                'technical_report': 'technical-report-section',
                'pr_strategy': 'pr-strategy-section',
                'pr_drafts': 'pr-strategy-section', // å…¼å®¹æ—§åç§°
                'legal_review': 'legal-review-section',
                'comprehensive_proposal': 'comprehensive-proposal-section',
                'approval_requests': 'approval-requests-section', // æ–°å¢
                'task_distribution': 'task-distribution-section',
                'department_execution': 'department-execution-section',
                'realtime_sentiment': 'realtime-sentiment-section',
                'human_decision': 'human-decision-section',
                'parsed_tasks': 'parsed-tasks-section',
                'executed_actions': 'executed-actions-section',
                'incident_log': 'incident-log-section',
                'post_mortem_report': 'post-mortem-report-section'
            };

            const sectionId = sectionMap[type];
            if (sectionId) {
                const section = document.getElementById(sectionId);
                const contentElement = document.getElementById(sectionId.replace('-section', '-content'));
                
                if (section && contentElement) {
                    section.style.display = 'block';
                    
                    // æ ¹æ®å†…å®¹ç±»å‹è¿›è¡Œç‰¹æ®Šæ ¼å¼åŒ–
                    let formattedContent = '';
                    
                    if (type === 'approval_requests') {
                        // ç‰¹æ®Šå¤„ç†æ‰¹å‡†è¯·æ±‚ï¼Œä¸åœ¨è¿™é‡Œå¤„ç†ï¼Œç”±ä¸“é—¨çš„å‡½æ•°å¤„ç†
                        return;
                    } else if (type === 'pr_strategy' || type === 'pr_drafts') {
                        // å¤„ç†å…¬å…³ç­–ç•¥ï¼ˆå¯èƒ½æ˜¯JSONæ ¼å¼ï¼‰
                        if (typeof content === 'object') {
                            if (content.sincere || content.reassuring || content.deflecting) {
                                // æ–°æ ¼å¼ï¼šåŒ…å«è¯¦ç»†ç­–ç•¥
                                formattedContent = `å¦è¯šç­–ç•¥:\n${JSON.stringify(content.sincere, null, 2)}\n\n`;
                                formattedContent += `å®‰æŠšç­–ç•¥:\n${JSON.stringify(content.reassuring, null, 2)}\n\n`;
                                formattedContent += `æ‹–å»¶ç­–ç•¥:\n${JSON.stringify(content.deflecting, null, 2)}`;
                            } else {
                                formattedContent = JSON.stringify(content, null, 2);
                            }
                        } else if (Array.isArray(content)) {
                            // æ—§æ ¼å¼ï¼šæ•°ç»„å½¢å¼
                            content.forEach((draft, index) => {
                                formattedContent += `æ–¹æ¡ˆ${index + 1} (${draft.tone}):\n${draft.draft}\n\n`;
                            });
                        } else {
                            formattedContent = content;
                        }
                    } else if (type === 'parsed_tasks') {
                        // å¤„ç†è§£æåçš„ä»»åŠ¡
                        if (typeof content === 'object' && content.tasks) {
                            formattedContent = 'ä»»åŠ¡åˆ†é…:\n';
                            content.tasks.forEach((task, index) => {
                                formattedContent += `${index + 1}. ${task.dept}: ${task.action}\n\n`;
                            });
                        } else {
                            formattedContent = JSON.stringify(content, null, 2);
                        }
                    } else if (type === 'executed_actions') {
                        // å¤„ç†æ‰§è¡Œç»“æœ
                        if (typeof content === 'object') {
                            formattedContent = 'æ‰§è¡Œç»“æœ:\n';
                            Object.entries(content).forEach(([dept, result]) => {
                                formattedContent += `${dept}:\n${result}\n\n`;
                            });
                        } else {
                            formattedContent = content;
                        }
                    } else if (type === 'incident_log') {
                        // å¤„ç†äº‹ä»¶æ—¥å¿—
                        if (Array.isArray(content)) {
                            formattedContent = content.join('\n\n');
                        } else {
                            formattedContent = content;
                        }
                    } else {
                        // é»˜è®¤å¤„ç†
                        if (typeof content === 'object') {
                            formattedContent = JSON.stringify(content, null, 2);
                        } else {
                            formattedContent = content;
                        }
                    }
                    
                    contentElement.textContent = formattedContent;
                    
                    // æ»šåŠ¨åˆ°æ–°å†…å®¹
                    section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        function enableCommandInput() {
            commandInputEnabled = true;
            document.getElementById('commandInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('commandInput').placeholder = 'æ€»æŒ‡æŒ¥å®˜ï¼Œè¯·ä¸‹è¾¾æŒ‡ä»¤...ï¼ˆéšæ—¶å¯è¾“å…¥ï¼‰';
            // ä¸è‡ªåŠ¨èšç„¦ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·æ“ä½œ
        }

        function sendCommand() {
            const input = document.getElementById('commandInput');
            const command = input.value.trim();
            
            if (command && commandInputEnabled) {
                console.log('ğŸ“¤ å‘é€æŒ‡ä»¤:', command);
                socket.emit('human_command', { command: command });
                commandInputEnabled = false;
            }
        }

        function confirmCrisisStatus(resolved) {
            console.log('ğŸ“‹ ç¡®è®¤å±æœºçŠ¶æ€:', resolved ? 'å·²è§£å†³' : 'æœªè§£å†³');
            socket.emit('crisis_decision', { resolved: resolved });
            document.getElementById('crisisModal').style.display = 'none';
        }

        function updateApprovalRequests(requests) {
            const section = document.getElementById('approval-requests-section');
            const contentElement = document.getElementById('approval-requests-content');
            
            if (!requests || requests.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            // æ™ºèƒ½ä½“åç§°æ˜ å°„
            const agentNameMap = {
                'sentiment_sentinel': 'ğŸ“ˆ èˆ†æƒ…å“¨å…µ',
                'technical_diagnostician': 'ğŸ”§ é¦–å¸­æŠ€æœ¯è¯Šæ–­å®˜',
                'pr_strategist': 'ğŸ“¢ å…¬å…³ç­–ç•¥å¸ˆ',
                'legal_counsel': 'âš–ï¸ æ³•åŠ¡ä¸åˆè§„é¡¾é—®',
                'decision_gateway': 'ğŸ‘‘ å†³ç­–ä¸­å¿ƒ',
                'action_coordinator': 'ğŸ¯ è·¨éƒ¨é—¨è¡ŒåŠ¨åè°ƒå®˜',
                'status_check': 'âœ… å±æœºçŠ¶æ€æ£€æŸ¥',
                'post_mortem_analyst': 'ğŸ“ å¤ç›˜åˆ†æå¸ˆ'
            };
            
            section.style.display = 'block';
            contentElement.innerHTML = '';
            
            requests.forEach((request, index) => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'approval-request';
                
                let statusHtml = '';
                if (request.status === 'pending') {
                    statusHtml = `
                        <div class="approval-buttons">
                            <button class="approval-btn approve" onclick="approveAction('${request.agent}')">
                                âœ… æ‰¹å‡†
                            </button>
                            <button class="approval-btn reject" onclick="rejectAction('${request.agent}')">
                                âŒ æ‹’ç»
                            </button>
                        </div>
                    `;
                } else {
                    const statusClass = request.status === 'approved' ? 'approved' : 'rejected';
                    const statusText = request.status === 'approved' ? 'âœ… å·²æ‰¹å‡†' : 'âŒ å·²æ‹’ç»';
                    statusHtml = `<div class="approval-status ${statusClass}">${statusText}</div>`;
                }
                
                const friendlyName = agentNameMap[request.agent] || request.agent;
                
                requestDiv.innerHTML = `
                    <div class="approval-agent">${friendlyName}</div>
                    <div class="approval-action">ğŸ“‹ ${request.action}</div>
                    <div class="approval-explanation">"${request.explanation}"</div>
                    ${statusHtml}
                `;
                
                contentElement.appendChild(requestDiv);
            });
            
            // æ»šåŠ¨åˆ°æ‰¹å‡†è¯·æ±‚åŒºåŸŸ
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function approveAction(agentName) {
            console.log('âœ… æ‰¹å‡†è¡ŒåŠ¨:', agentName);
            socket.emit('approval_decision', { 
                agent_name: agentName, 
                approved: true 
            });
        }

        function rejectAction(agentName) {
            console.log('âŒ æ‹’ç»è¡ŒåŠ¨:', agentName);
            socket.emit('approval_decision', { 
                agent_name: agentName, 
                approved: false 
            });
        }

        function resetSystem() {
            document.querySelector('.start-btn').disabled = false;
            document.querySelector('.start-btn').textContent = 'ğŸš€ å¯åŠ¨ç¥ç›¾ç³»ç»Ÿ';
            document.querySelector('.stop-btn').disabled = true;
            document.getElementById('commandInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('commandInput').placeholder = 'ç³»ç»Ÿæœªå¯åŠ¨';
            commandInputEnabled = false;
            
            // é‡ç½®æ‰€æœ‰è¿æ¥çº¿
            document.querySelectorAll('.connection-line').forEach(line => {
                line.classList.remove('active');
            });
            
            // é‡ç½®æ‰€æœ‰æ™ºèƒ½ä½“åˆ°å¾…æœºçŠ¶æ€ï¼ˆæ¸…é™¤ä»»ä½•å®šæ—¶å™¨æ•ˆæœï¼‰
            document.querySelectorAll('.agent-node').forEach(node => {
                node.classList.remove('active', 'completed', 'waiting');
                const statusElement = node.querySelector('.agent-status');
                const messageElement = node.querySelector('.agent-message');
                if (statusElement) statusElement.textContent = 'å¾…æœº';
                if (messageElement) messageElement.textContent = '';
            });
        }

        // å›è½¦é”®å‘é€æŒ‡ä»¤
        document.getElementById('commandInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('sendBtn').disabled) {
                sendCommand();
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('crisisModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html> 